\section{Evaluation}\label{sec:evaluation}

\subsection{Experimental Setup}

We implement SwitchCrypt and our experiments on a Hardkernel Odroid XU3 ARM
big.LITTLE system with Samsung Exynos 5422 A15/A7 heterogeneous multi-processing
quad core CPUs at maximum clock speed, 2 gigabyte LPDDR3 RAM at 933 MHz, and an
eMMC5.0 HS400 backing store running Ubuntu Trusty 14.04.6 LTS, kernel version
3.10.106.

We evaluate SwitchCrypt using a Linux RAM disk (tmpfs). The maximum theoretical
memory bandwidth for this Odroid model is 14.9GB/s\@. Our observed maximum
memory bandwidth is 4.5GB/s. Using a RAM disk focuses the evaluation on the 
performance differences due to different ciphers.

In each experiment below, we evaluate SwitchCrypt on two high level workloads:
sequential and random I/O. In both workloads, a number of bytes are written and
then read (either 4KB, 512KB, 5MB, 40MB) 10 times. Each experiment is repeated
three times.

When evaluating switching strategies, a finer breakdown in workloads is made
using a pre-selected pair of ciphers, yielding a cipher configuration point
given some switching strategy; a specific \emph{ratio} of those 10 write-read
pairs is performed using one cipher and the remainder with the other. These
ratio workloads test SwitchCrypt's ability to reach configuration points not
accessible to prior work.

There are three ratios we use to evaluate SwitchCrypt's performance in this
regard: 1:3, 1:1, and 3:1. Respectively, that is 1 whole file write-read
operation in the primary cipher for every 3 whole file write-read operations in
the secondary cipher (1:3), 1 whole file write-read operation in the primary
cipher for every other whole file write-read operation in the secondary cipher
(1:1), and 3 whole file write-read operations in the primary cipher for every 1
whole file write-read operation in the secondary cipher (3:1). \TODO{primary/secondary terminology again, although it makes more sense here in the narrower context of evaluation.} The security
score for each ratio point is calculated as $score$=$score_L + ||score_L -
score_H|| * r * 0.25)$ where $score_L$ is the lowest security score
(configuration), $score_H$ is the highest, and $r$ is a number representing the
ratio; 1:3=3, 1:1=2, and 3:1=1.

All experiments are performed with basic Linux I/O commands, bypassing system
caching.

In this section we answer the following questions:

\begin{enumerate}
 \item What shape does the cipher configuration tradeoff space take under
 our workloads?
 \item Can SwitchCrypt achieve dynamic security/energy tradeoffs by reaching
 configuration points not accessible with prior work?
 \item What is the performance and storage overhead of each cipher switching
 strategy?
 \item How does incorporation of cipher-switching change the threat analysis
 versus prior work?
\end{enumerate}

\subsection{Switching Strategies Under Various Workloads}

\begin{figure}[ht]
  \textbf{Baseline Cipher I/O Performance}\par\medskip
  {\input{charts/tradeoff-no-ratios.tex}} \caption{Median sequential and random
  read and write performance baseline.}
 \label{fig:tradeoff-no-ratios}
\end{figure}

\figref{tradeoff-no-ratios} shows the security score versus median normalized
latency tradeoff between different stream ciphers when completing our sequential
and random I/O workloads. \TODO{Might be interesting to get the 95\% latencies too.  It would certainly be strong to claim that the trends for median hold when looking at tail latencies, as well.} Each line represents one workload. From left to right:
4K, 512K, 5M, and 40M respectively. Each symbol represents one of our ciphers.
From left to right: ChaCha8, ChaCha20, Freestyle Fast, Freestyle Balanced, and
Freestyle Secure. As expected, of the ciphers we tested, those with higher
security scores result in higher latency for I/O operations while ciphers with
less desirable security properties result in lower latency. The relationship
between these concerns is not simply linear, however, which exposes a rich
security vs latency/energy tradeoff space.

Besides the 4K workload, each workload follows a similar superlinear
latency-vs-security slope, hence we will mostly focus on 40MB and 4K workloads
going forward. Due to the overhead of metadata management and the fast
completion time of the 4K workloads (\ie{little time for amortization of
overhead}), ChaCha8 and ChaCha20 take longer to complete than the higher scoring
Freestyle Fast. This advantage is not enough to make Freestyle Balanced or
Secure complete faster than the ChaCha variants, however.

Though ChaCha8 is generally faster than ChaCha20, there is some variability in
our timing setup when capturing extremely fast events occurring close together
in time. This is why ChaCha8 sometimes appears with higher latency than
ChaCha20 for normalized 4K workloads. ChaCha8 is not slower than ChaCha20.

\subsection{Reaching Between Static Configuration Points}

\begin{figure}[ht]
  \textbf{Forward Switching I/O Ratio Performance}\par\medskip
  {\input{charts/tradeoff-with-ratios.tex}} \caption{Median sequential and
  random read and write performance comparison of Forward switching to
  baseline.}
 \label{fig:tradeoff-with-ratios}
\end{figure}

\figref{tradeoff-with-ratios} shows the security score versus median normalized
latency tradeoff between different stream ciphers when completing our sequential
and random I/O workloads \emph{with cipher switching using the Forward
strategy}. As with \figref{tradeoff-no-ratios}, each line represents one
workload and each symbol represents one of our ciphers. From left to right:
ChaCha8, ChaCha20, Freestyle Fast, Freestyle Balanced, and Freestyle Secure.

After a certain number of write-read I/O operations, a cipher switch is
initiated and SwitchCrypt begins using the secondary cipher to encrypt and
decrypt data. For each pair of ciphers, this is repeated three times: once at
every ratio point \emph{between} our static configuration points (\ie{1:3, 1:1,
and 3:1 described above}).

The point of this experiment is to determine if SwitchCrypt can effectively
transition the backing store between ciphers without devastating performance.
For the 40M, 5M, and 512K workloads (40M is shown), we see that SwitchCrypt can
achieve configuration points between the static baseline that is unreachable via
prior work using single ciphers, all with minimal overhead.

Again, due to the overhead of metadata management for non-Freestyle ciphers (see
\secref{implementation}) and the fast completion time of the 4K workloads
preventing SwitchCrypt from taking advantage of amortization, ChaCha8 and
ChaCha20 take longer to complete than the higher scoring Freestyle Fast for 4K
reads. This advantage is not enough to make the ratios involving Freestyle
Balanced or Secure complete faster than the ChaCha ratio variants, however.

We also see very high latency for ratios between Freestyle Fast and Freestyle
Secure cipher configurations. This is because Freestyle, while avoiding metadata
management overhead, is not length-preserving (so extra write operations must be
performed), and is generally much slower than the ChaCha variants (see
\figref{tradeoff-no-ratios}). Doubly invoking Freestyle in a ratio configuration
means these penalties are paid more often, ballooning latency.

\begin{figure*}[ht]
  \textbf{Mirrored and Selective Switching I/O Ratio Performance}\par\medskip
  \centering
  {\input{charts/mirrored-selective-baseline.tex}} \caption{Median sequential
  and random read and write performance comparison of Mirrored and Selective
  switching strategies to baseline.}
 \label{fig:mirrored-selective-baseline}
\end{figure*}

\figref{mirrored-selective-baseline} show the the performance of the Mirrored
and Selective strategies with the same configuration of ratios as
\figref{tradeoff-with-ratios}.

For the 40M, 5M, and 512K workloads (40M is shown), we see that Mirrored and
Selective \emph{read} workloads and the Selective \emph{write} workload achieve
parity with the Forward strategy experiments. This makes sense, as the only
overhead for Selective and Mirrored reads is determining which part of the
backing store to commit data to, a trivial process. The same applies to
Selective writes.

For the 4K Mirrored and Selective \emph{read} workloads and the Selective
\emph{write} workload, we see behavior similar to that in
\figref{tradeoff-with-ratios}, as expected.

Mirrored writes across all workloads are very slow. This is to be expected,
since the data is being mirrored across all areas of the backing store. In our
experiments, the backing store can be considered partitioned in half. This
overhead is most egregious for the 4K Mirrored write workload. This makes
Selective preferable to Mirrored; however, Selective can never converge the
backing store to a single cipher configuration or survive the loss of an entire
region (see: \secref{sec:usecases}).

\subsection{Cipher Switching Overhead}

From the results of the previous three experiments, we calculate that Forward
switching has between \TODO{X} and \TODO{Y} latency overhead compared to
baseline I/O, with average overhead at \TODO{XX} for 40M, 5M and 512K workloads
and average overhead at \TODO{YY} for 4K read workloads and \TODO{YYY} for 4K
write workloads. There is no spatial overhead with the Forward switching
strategy.

Similarly, we calculate that Selective switching has between \TODO{X} and
\TODO{Y} latency overhead compared to baseline I/O, with average overhead at
\TODO{XX} for 40M, 5M and 512K workloads and average overhead at \TODO{YY} for
4K read workloads and \TODO{YYY} for 4K write workloads. Read overhead. Spatial
overhead was half of all writable space on the backing store.

Finally, we calculate that Mirrored switching has between \TODO{X} and \TODO{Y}
read latency overhead and between \TODO{X} and \TODO{Y} write overhead compared
to baseline I/O, with average overhead at \TODO{XX}/\TODO{XXX} for 40M, 5M and
512K read/write workloads and average overhead at \TODO{YY}/\TODO{YYY} for 4K
read/write workloads. Spatial overhead was half of all writable space on the
backing store.

These overhead numbers are the penalty paid for the additional flexibility of being able to 
reach configurations points that are simply unachievable without SwitchCrypt.  We believe SwitchCrypt's design keeps these overheads acceptably low and thus achieves the desired goal of flexibly navigating latency/security tradeoffs for full drive encryption.

\subsection{Augmented Threat Analysis}

\tblref{security} lists possible attacks and their results. It can be inferred
from these results and SwitchCrypt's design that SwitchCrypt addresses its
threat model and maintains confidentiality and integrity guarantees.

\begin{table}[t]
  \caption{Attacks on SwitchCrypt and their results}\label{tbl:security}
  \footnotesize
  \centering
  \begin{tabu} to \linewidth { | X[l] | X[c] | X[c] | }
    \hline
    \textbf{Attack} & \textbf{Result} & \textbf{Explanation} \\
    \hline\hline
    Nugget user data in backing store is mutated out-of-band online &
    SwitchCrypt immediately fails with exception on successive IO request &
    Regardless of switching strategy, Merkle Tree check fails on read-in\\
    \hline
    Header/cipher metadata in backing store is mutated out-of-band online &
    SwitchCrypt immediately fails with exception on successive IO request &
    Regardless of switching strategy, Merkle Tree check fails on read-in\\
    \hline
    Backing store is rolled back to a previously consistent state while online &
    SwitchCrypt immediately fails with exception on successive IO request &
    Regardless of switching strategy, secure monotonic counter is out of sync
    with the system\\
    \hline
    Backing store is rolled back to a previously consistent state while offline,
    secure counter wildly out of sync & SwitchCrypt refuses to mount; allows for
    force mount with root access & Regardless of switching strategy, secure
    monotonic counter is out of sync with the system\\
    \hline
    Merkle Tree made inconsistent by mutating backing store out-of-band while
    offline, secure counter in sync & SwitchCrypt refuses to mount & Secure
    monotonic counter is in sync with the system, yet illegal data manipulation
    occurred\\
    \hline\hline
  \end{tabu}
\end{table}

\TODO{There is at least one more attack that needs to be addressed.  I think this approach is susceptible to physical attacks.  If we encrypt some data with ChaCha8 and then swtich the active cipher to Freestyle, if an attacker accesses data through our system, they will get the Freestyle version, right?  But, if they can remove the storage from our software, the ChaCha8 version is there. I guess that I assumed forward when I wrote that, but something similar is ture for mirrored.  I think we need to acknowledge (agian) that an attacker could access data that has not been switched yet.  That is a new threat and the only solution I can see is to be careful.  We might say that we should combine strategies in some cases.  Like use selective with the best freestyle on one side and write your most sensitive data there, then on the other side, use forward switching.  I may not be coherent anymore...}

\TODO{One more thing: you never explicitly say what the answer to all those qwustions is.  I like the questions at the beginning.  Now you need to declare victory.}